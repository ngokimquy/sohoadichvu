<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra c·ª©u d·ªãch v·ª• ƒë√£ ƒëƒÉng k√Ω</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 32px 24px; }
        h1 { color: #0984e3; text-align: center; margin-bottom: 18px; }
        .form-group { margin-bottom: 20px; }
        label { font-weight: bold; color: #333; display: block; margin-bottom: 8px; }
        input { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; }
        button { background: #0984e3; color: #fff; border: none; border-radius: 8px; padding: 12px 28px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #00b894; }
        #resultArea { margin-top: 30px; }
        .result-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .result-table th, .result-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; }
        .result-table th { background: #f9f9f9; color: #0984e3; }
        .result-table tr:nth-child(even) { background: #f8f8f8; }
        .no-result { color: #dc3545; text-align: center; margin-top: 24px; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tra c·ª©u d·ªãch v·ª• ƒë√£ ƒëƒÉng k√Ω</h1>
        <form id="lookupForm">
            <div class="form-group">
                <label for="apartment">M√£ cƒÉn h·ªô</label>
                <input type="text" id="apartment" name="apartment" required placeholder="Nh·∫≠p m√£ cƒÉn h·ªô">
            </div>
            <div class="form-group">
                <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="tel" id="phone" name="phone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
            </div>
            <button type="submit">Ki·ªÉm tra</button>
        </form>
        <div id="resultArea"></div>
    </div>
    <script>
        function vietHoaTrangThai(status) {
            switch ((status || '').toLowerCase()) {
                case 'pending': return 'ƒêang ch·ªù';
                case 'completed': return 'ƒê√£ ho√†n th√†nh';
                case 'approved': return 'ƒê√£ ho√†n th√†nh';
                case 'rejected': return 'T·ª´ ch·ªëi';
                case 'canceled': return 'ƒê√£ h·ªßy';
                default: return status || '';
            }
        }

        function showDetailModal(idx) {
            const r = window._lookupResults[idx];
            let html = '';
            // Vi·ªát h√≥a t√™n tr∆∞·ªùng
            const vietnameseFieldNames = {
                'service': 'D·ªãch v·ª•',
                'created_at': 'Ng√†y ƒëƒÉng k√Ω',
                'status': 'Tr·∫°ng th√°i',
                'note': 'Ghi ch√∫',
                'apartment': 'CƒÉn h·ªô',
                'phone': 'S·ªë ƒëi·ªán tho·∫°i',
                'fullName': 'H·ªç v√† t√™n',
                'email': 'Email',
                'role': 'Vai tr√≤',
                'moveDate': 'Ng√†y v·∫≠n chuy·ªÉn',
                'moveTime': 'Khung gi·ªù v·∫≠n chuy·ªÉn',
                'goodsDesc': 'M√¥ t·∫£ h√†ng h√≥a',
                'movingType': 'Lo·∫°i v·∫≠n chuy·ªÉn',
                'constructionType': 'Lo·∫°i thi c√¥ng',
                'description': 'M√¥ t·∫£',
                'ad_type': 'Lo·∫°i qu·∫£ng c√°o',
                'ad_content': 'N·ªôi dung qu·∫£ng c√°o',
                'camera_location': 'V·ªã tr√≠ camera',
                'pet_type': 'Lo·∫°i v·∫≠t nu√¥i',
                'pet_name': 'T√™n v·∫≠t nu√¥i',
                'community_room': 'Ph√≤ng c·ªông ƒë·ªìng',
                'pool_name': 'T√™n h·ªì b∆°i',
                'ownerName': 'T√™n ch·ªß xe',
                'licensePlate': 'Bi·ªÉn s·ªë xe',
                'vehicleType': 'Lo·∫°i xe',
                'registrationDate': 'Ng√†y ƒëƒÉng k√Ω',
                'resident_name': 'T√™n c∆∞ d√¢n',
                'resident_phone': 'SƒêT c∆∞ d√¢n',
                'resident_apartment': 'CƒÉn h·ªô c∆∞ d√¢n',
                // ...b·ªï sung n·∫øu c·∫ßn
            };
            for (const key in r) {
                if (typeof r[key] === 'string' && r[key].match(/^https?:\/\//)) continue; // B·ªè qua link h√¨nh ·∫£nh
                if (typeof r[key] === 'object' && r[key] !== null) continue; // B·ªè qua object/ph·ª©c t·∫°p
                if (key === 'status') {
                    html += `<div style='margin-bottom:10px;'><b style="color:#333;">${vietnameseFieldNames[key]||key}:</b> <span>${vietHoaTrangThai(r[key])}</span></div>`;
                } else if (vietnameseFieldNames[key]) {
                    html += `<div style='margin-bottom:10px;'><b style="color:#333;">${vietnameseFieldNames[key]}:</b> <span>${r[key]}</span></div>`;
                } else if (typeof r[key] === 'string' && r[key]) {
                    html += `<div style='margin-bottom:10px;'><b style="color:#333;">${key}:</b> <span>${r[key]}</span></div>`;
                }
            }
            if (!html) html = '<i>Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt</i>';
            let modal = document.getElementById('detailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'detailModal';
                modal.style.cssText = 'display:flex;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;';
                modal.innerHTML = `<div style="background:#fff;max-width:420px;width:100%;padding:32px 24px 18px 24px;border-radius:14px;box-shadow:0 8px 32px rgba(124,92,246,0.18);position:relative;overflow-y:auto;max-height:90vh;">
                    <button onclick="closeDetailModal()" style="position:absolute;top:10px;right:16px;font-size:1.5em;background:none;border:none;cursor:pointer;color:#666;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;">&times;</button>
                    <h2 style="margin-top:0;font-size:1.15em;color:#0984e3;border-bottom:2px solid #0984e3;padding-bottom:8px;">Chi ti·∫øt ƒëƒÉng k√Ω</h2>
                    <div id="detailContent" style="margin-top:18px;font-size:1.08em;color:#222;line-height:1.5;"></div>
                </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('detailContent').innerHTML = html;
            modal.style.display = 'flex';
        }
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            if (modal) modal.style.display = 'none';
        }

        document.getElementById('lookupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const phone = document.getElementById('phone').value.trim();
            const apartment = document.getElementById('apartment').value.trim();
            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = '<div style="text-align:center;color:#888;">ƒêang tra c·ª©u...</div>';
            try {
                const res = await fetch(`/api/registration-lookup?phone=${encodeURIComponent(phone)}&apartment=${encodeURIComponent(apartment)}`);
                const data = await res.json();
                if (data.success && data.results.length > 0) {
                    let html = '<table class="result-table"><thead><tr><th>STT</th><th>D·ªãch v·ª•</th><th>Ng√†y ƒëƒÉng k√Ω</th><th>Tr·∫°ng th√°i</th><th>Ghi ch√∫</th><th>Chi ti·∫øt</th></tr></thead><tbody>';
                    data.results.forEach((item, idx) => {
                        html += `<tr>
                            <td>${idx + 1}</td>
                            <td>${item.service}</td>
                            <td>${item.created_at}</td>
                            <td>${vietHoaTrangThai(item.status)}</td>
                            <td>${item.note || ''}</td>
                            <td style="text-align:center;font-size:1.3em;">
                                <span title="Xem chi ti·∫øt" style="cursor:pointer;" onclick="showDetailModal(${idx})">üîç</span>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    resultArea.innerHTML = html;
                    window._lookupResults = data.results;
                } else {
                    resultArea.innerHTML = '<div class="no-result">Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒëƒÉng k√Ω ph√π h·ª£p!</div>';
                }
            } catch (err) {
                resultArea.innerHTML = '<div class="no-result">C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau.</div>';
            }
        });
    </script>
</body>
</html>