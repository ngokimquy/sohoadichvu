<!DOCTYPE html>
<html>
<head>
  <title>Đăng Ký & Cam Kết Vật Nuôi</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #0984e3, #00b894); color: white; text-align: center; padding: 30px 20px; }
    .header h1 { font-size: 2em; margin-bottom: 10px; }
    .form-container { padding: 40px; }
    .section { margin-bottom: 40px; }
    .section-title { font-size: 1.3em; color: #333; margin-bottom: 20px; font-weight: bold; border-bottom: 2px solid #0984e3; padding-bottom: 10px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #0984e3; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-row-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-row-3col .form-group label { font-size: 14px; min-width: 80px; margin-bottom: 6px; }
    @media (max-width: 768px) { .form-row, .form-row-3col { grid-template-columns: 1fr; } .form-container { padding: 20px; } }
    .file-upload { border: 2px dashed #0984e3; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
    .file-upload:hover { background-color: #f8f9fa; }
    .file-upload input[type="file"] { display: none; }
    .file-upload-icon { font-size: 3em; color: #0984e3; margin-bottom: 10px; }
    .file-upload-text { color: #666; font-size: 14px; }
    .file-preview { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none; }
    .signature-section { border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; text-align: center; }
    .signature-canvas { border: 1px solid #ddd; border-radius: 5px; cursor: crosshair; width: 400px; height: 200px; max-width: 100%; display: block; margin: 0 auto; }
    @media (max-width: 600px) { .signature-canvas { width: 100% !important; min-width: 220px; height: 320px !important; max-width: 100vw; } }
    .signature-buttons { margin-top: 15px; }
    .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin: 5px; }
    .btn-primary { background: #0984e3; color: white; }
    .btn-primary:hover { background: #00b894; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .btn-success { background: #28a745; color: white; width: 100%; font-size: 18px; padding: 15px; }
    .btn-success:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Đăng Ký & Cam Kết Vật Nuôi</h1>
      <p>Vui lòng điền đầy đủ thông tin để đăng ký và cam kết tuân thủ nội quy vật nuôi</p>
    </div>
    <div class="form-container">
      <form id="petsCommitmentForm" enctype="multipart/form-data">
        <div class="section">
          <h2 class="section-title">Thông Tin Cá Nhân</h2>
          <div class="form-row form-row-3col">
            <div class="form-group">
              <label for="fullName">Họ và Tên</label>
              <input type="text" id="fullName" name="fullName" required>
            </div>
            <div class="form-group">
              <label for="phone">Số ĐT</label>
              <input type="tel" id="phone" name="phone" required>
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" name="email">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="apartment">Số Căn Hộ</label>
              <input type="text" id="apartment" name="apartment" required>
            </div>
            <div class="form-group">
              <label for="role">Vai Trò Trong Căn Hộ</label>
              <select id="role" name="role" required>
                <option value="" disabled selected hidden>-- Vui lòng chọn vai trò --</option>
                <option value="chu_ho">Chủ Hộ</option>
                <option value="khach_thue">Khách Thuê</option>
                <option value="khac">Khác</option>
              </select>
            </div>
          </div>
        </div>
        <div class="section">
          <h2 class="section-title">Thông Tin Vật Nuôi</h2>
          <div class="form-row">
            <div class="form-group">
              <label for="petType">Loại vật nuôi</label>
              <input type="text" id="petType" name="petType" required placeholder="Chó, mèo, ...">
            </div>
            <div class="form-group">
              <label for="petQuantity">Số lượng vật nuôi</label>
              <input type="number" id="petQuantity" name="petQuantity" min="1" required>
            </div>
          </div>
          <div class="form-group">
            <label for="petReason">Mô tả thông tin vật nuôi</label>
            <textarea id="petReason" name="petReason" rows="2" placeholder="Ví dụ: Tên: Mimi, Loại: Mèo, Giống: Anh lông ngắn, Tuổi: 2 năm, Trọng lượng: 4kg..."></textarea>
          </div>
          <div class="form-group">
            <label for="petImage">Upload hình ảnh vật nuôi</label>
            <input type="file" id="petImage" name="petImage" accept="image/*" required onchange="previewPetImage(event)">
            <div id="petImagePreview" class="file-preview"></div>
          </div>
        </div>
        <div class="section">
          <h2 class="section-title">Chữ Ký Xác Nhận</h2>
          <div class="signature-section">
            <p style="margin-bottom: 15px;">Vui lòng ký tên để xác nhận thông tin:</p>
            <canvas id="signatureCanvas" class="signature-canvas" width="400" height="200"></canvas>
            <div class="signature-buttons">
              <button type="button" class="btn btn-secondary" onclick="clearSignature()">Xóa Chữ Ký</button>
            </div>
          </div>
        </div>
        <div class="section">
          <button type="submit" class="btn btn-success">Gửi Cam Kết</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // Signature canvas logic (giữ nguyên như car-registration)
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let isDrawing = false;
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    canvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      isDrawing = true;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      ctx.beginPath();
      ctx.moveTo(x, y);
    }, { passive: false });
    canvas.addEventListener('touchmove', function(e) {
      e.preventDefault();
      if (!isDrawing) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }, { passive: false });
    canvas.addEventListener('touchend', function(e) {
      e.preventDefault();
      isDrawing = false;
      ctx.beginPath();
    }, { passive: false });
    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }
    function draw(e) {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }
    function stopDrawing() {
      if (isDrawing) {
        isDrawing = false;
        ctx.beginPath();
      }
    }
    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function isCanvasSigned(canvas) {
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        if (!(data[i] === 255 && data[i+1] === 255 && data[i+2] === 255 && data[i+3] === 255)) {
          return true;
        }
      }
      return false;
    }
    // Form submission
    document.getElementById('petsCommitmentForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const formData = new FormData(form);
      // Add signature
      const signatureData = canvas.toDataURL();
      formData.append('signature', signatureData);
      // Validate signature
      if (!isCanvasSigned(canvas)) {
        alert('Vui lòng ký tên xác nhận!');
        return;
      }
      try {
        const response = await fetch('/api/pets-commitment-register', {
          method: 'POST',
          body: formData
        });
        if (response.ok) {
          const result = await response.json();
          showSuccessPopup({
            fullName: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            apartment: document.getElementById('apartment').value,
            petType: document.getElementById('petType').value,
            petQuantity: document.getElementById('petQuantity').value,
            petReason: document.getElementById('petReason').value,
            chungcuName: result.chungcuName,
            createdAt: result.createdAt
          });
        } else {
          const err = await response.json();
          alert(err.error || 'Có lỗi xảy ra. Vui lòng thử lại.');
        }
      } catch (error) {
        alert('Có lỗi xảy ra. Vui lòng thử lại.');
      }
    });
    // Popup xác nhận thành công
    function showSuccessPopup(info) {
      let dateStr = '';
      if (info.createdAt) {
        try {
          const d = new Date(info.createdAt);
          dateStr = d.toLocaleString('vi-VN', { hour12: false });
        } catch (e) { dateStr = info.createdAt; }
      }
      const popup = document.createElement('div');
      popup.id = 'successPopup';
      popup.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popup.innerHTML = `
        <div id="popupContent" style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;max-width:420px;width:95%;box-shadow:0 8px 32px rgba(9,132,227,0.10);text-align:center;">
          <div style="font-size:2.2em;color:#28a745;margin-bottom:12px;">✔️</div>
          <div style="font-size:1.3em;font-weight:700;color:#0984e3;margin-bottom:10px;">Gửi cam kết vật nuôi thành công!</div>
          <div style="font-size:1.1em;font-weight:600;color:#333;margin-bottom:8px;">${info.chungcuName ? 'Chung cư: ' + info.chungcuName : ''}</div>
          <div style="font-size:1em;color:#555;margin-bottom:8px;">${dateStr ? 'Ngày gửi: ' + dateStr : ''}</div>
          <div style="text-align:left;font-size:1em;margin-bottom:12px;">
            <b>Họ tên:</b> ${info.fullName}<br>
            <b>Email:</b> ${info.email}<br>
            <b>Số điện thoại:</b> ${info.phone}<br>
            <b>Căn hộ/Đơn vị:</b> ${info.apartment}<br>
            <b>Loại vật nuôi:</b> ${info.petType}<br>
            <b>Số lượng:</b> ${info.petQuantity}<br>
            <b>Lý do/thông tin:</b> ${info.petReason}<br>
          </div>
          <button class="btn btn-primary" onclick="downloadRegistrationInfo()">Tải xuống thông tin</button>
          <button class="btn btn-secondary" style="margin-left:10px;" onclick="closeSuccessPopup()">Đóng</button>
        </div>
      `;
      document.body.appendChild(popup);
      window._lastRegistrationInfo = info;
    }
    function closeSuccessPopup() {
      const popup = document.getElementById('successPopup');
      if (popup) popup.remove();
      window.location.href = '/tenants/utility-services';
    }
    function downloadRegistrationInfo() {
      const popupContent = document.getElementById('popupContent');
      if (!popupContent) return;
      html2canvas(popupContent).then(function(canvas) {
        const link = document.createElement('a');
        link.download = 'thong-tin-dang-ky-vat-nuoi.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
    // Responsive canvas size
    function resizeSignatureCanvas() {
      const canvas = document.getElementById('signatureCanvas');
      let w = 400, h = 200;
      if (window.innerWidth < 600) {
        w = Math.max(window.innerWidth - 40, 220);
        h = 320;
      }
      canvas.width = w;
      canvas.height = h;
      ctx.clearRect(0, 0, w, h);
    }
    window.addEventListener('resize', resizeSignatureCanvas);
    resizeSignatureCanvas();

    function previewPetImage(event) {
      const preview = document.getElementById('petImagePreview');
      preview.innerHTML = '';
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.style.display = 'block';
          preview.innerHTML = `<img src="${e.target.result}" alt="Ảnh vật nuôi" style="max-width:180px;max-height:180px;border-radius:8px;box-shadow:0 2px 8px #eee;">`;
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = 'none';
        preview.innerHTML = '';
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
