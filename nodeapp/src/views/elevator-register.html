<!DOCTYPE html>
<html>
<head>
  <title>Đăng Ký Thẻ Thang Máy</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; }
    .header { background: linear-gradient(135deg, #00b894, #00cec9); color: #fff; text-align: center; padding: 40px 20px; }
    .header h1 { font-size: 2.2em; margin-bottom: 10px; }
    .header p { font-size: 1.1em; opacity: 0.9; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); padding: 40px 32px; margin-top: 40px; }
    .form-title { text-align: center; font-size: 1.5em; color: #00b894; font-weight: bold; margin-bottom: 30px; }
    .section-title {
      font-size: 1.25em;
      font-weight: bold;
      margin-bottom: 10px;
      margin-top: 10px;
      color: #222;
      border-bottom: 3px solid #a259ff;
      padding-bottom: 4px;
      width: 100%;
    }
    .personal-info-row {
      display: flex;
      gap: 28px;
      margin-bottom: 26px;
      flex-wrap: wrap;
    }
    .personal-info-row .form-group {
      flex: 1 1 200px;
      min-width: 180px;
      margin-bottom: 0;
    }
    .form-group { margin-bottom: 22px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    .form-group input:focus, .form-group select:focus { border-color: #00b894; outline: none; }
    .submit-btn { width: 100%; padding: 16px 0; font-size: 18px; background: #00b894; color: #fff; font-weight: bold; border: none; border-radius: 12px; margin-top: 10px; transition: background 0.2s; }
    .submit-btn:hover { background: #00997a; }
    .alert { display: none; padding: 14px; border-radius: 8px; margin-bottom: 18px; }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .upload-label {
      font-size: 1.08em;
      font-weight: bold;
      margin-bottom: 8px;
      margin-top: 18px;
    }
    .upload-box {
      border: 2.5px dashed #a259ff;
      border-radius: 12px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-bottom: 22px;
      background: #faf7ff;
      transition: border-color 0.2s;
      padding: 24px 10px;
    }
    .upload-box:hover {
      border-color: #7c3aed;
      background: #f3eaff;
    }
    .upload-box.dragover {
      border-color: #ff6f00;
      background: #fffbe7;
    }
    .upload-text {
      color: #444;
      font-size: 1.05em;
      margin-top: 10px;
      opacity: 0.85;
    }
    .file-list {
      list-style: none;
      padding: 0 0 0 8px;
      margin: 0 0 18px 0;
      font-size: 0.98em;
      color: #5f27cd;
    }
    .file-list li {
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .file-list li:before {
      content: '\1F4C4';
      margin-right: 4px;
      font-size: 1.1em;
    }
    @media (max-width: 700px) {
      .container { padding: 24px 8px; }
      .personal-info-row {
        flex-direction: column;
        gap: 0;
        margin-bottom: 18px;
      }
      .personal-info-row .form-group {
        min-width: 100%;
        margin-bottom: 16px;
      }
      .upload-box { padding: 18px 2px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Đăng Ký Thẻ Thang Máy</h1>
    <p>Điền thông tin bên dưới để đăng ký thẻ sử dụng thang máy cho cư dân hoặc khách.</p>
  </div>
  <div class="container">
    <div class="form-title">Thông Tin Đăng Ký Thẻ Thang Máy</div>
    <form id="elevatorCardForm">
      <div class="section-title">Thông Tin Cá Nhân</div>
      <div class="personal-info-row">
        <div class="form-group">
          <label for="fullName">Họ và Tên</label>
          <input type="text" id="fullName" name="fullName" required>
        </div>
        <div class="form-group">
          <label for="phone">Số ĐT</label>
          <input type="tel" id="phone" name="phone" required>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email">
        </div>
      </div>
      <div class="personal-info-row">
        <div class="form-group">
          <label for="apartment">Số Căn Hộ</label>
          <input type="text" id="apartment" name="apartment" required>
        </div>
        <div class="form-group">
          <label for="role">Vai Trò Trong Căn Hộ</label>
          <select id="role" name="role" required>
            <option value="">-- Vui lòng chọn --</option>
            <option value="owner">Chủ Hộ</option>
            <option value="resident">Cư Dân</option>
            <option value="renter">Khách Thuê</option>
          </select>
        </div>
      </div>
      <div class="personal-info-row">
        <div class="form-group">
          <label for="cardQuantity">Số lượng đăng ký thẻ</label>
          <input type="number" id="cardQuantity" name="cardQuantity" min="1" max="10" value="1" required>
        </div>
        <div class="form-group">
          <label for="note">Ghi chú (nếu có)</label>
          <input type="text" id="note" name="note">
        </div>
      </div>
      <div class="section-title">Tải Lên Hồ Sơ</div>
      <div class="upload-label"><b>Vui lòng tải CCCD mặt trước lên (có thể chọn nhiều file)</b></div>
      <div class="upload-box" id="uploadBox">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity:0.7;"><rect x="8" y="6" width="24" height="36" rx="4" fill="#e9e4fa" stroke="#a259ff" stroke-width="2"/><rect x="14" y="14" width="12" height="2.5" rx="1.25" fill="#a259ff"/><rect x="14" y="20" width="12" height="2.5" rx="1.25" fill="#a259ff"/><rect x="14" y="26" width="12" height="2.5" rx="1.25" fill="#a259ff"/></svg>
        <div class="upload-text">Click hoặc kéo-thả file CCCD mặt trước vào đây</div>
        <input type="file" id="cccdFiles" name="cccdFiles" accept="image/*,.pdf" multiple required style="display:none;">
      </div>
      <ul id="fileList" class="file-list"></ul>
      <div id="successAlert" class="alert alert-success">Gửi đăng ký thành công!</div>
      <div id="errorAlert" class="alert alert-error"></div>
      <div class="section-title">Chữ Ký Xác Nhận</div>
      <div style="border:1.5px solid #e9e4fa;border-radius:10px;padding:18px 12px 18px 12px;margin-bottom:24px;background:#faf7ff;">
        <div style="font-weight:500;margin-bottom:10px;">Vui lòng ký tên để xác nhận thông tin:</div>
        <div style="display:flex;flex-direction:column;align-items:center;">
          <canvas id="signatureCanvas" style="background:#fff;border:1.5px solid #bbb;border-radius:8px;width:340px;height:140px;max-width:100%;margin-bottom:14px;cursor:crosshair;"></canvas>
          <button type="button" id="clearSignatureBtn" style="background:#636e72;color:#fff;padding:10px 28px;border:none;border-radius:7px;font-size:1em;font-weight:600;box-shadow:0 2px 8px #e9e4fa;cursor:pointer;">Xóa Chữ Ký</button>
        </div>
        <input type="hidden" id="signature" name="signature">
      </div>
      <button type="submit" class="submit-btn">Gửi Đăng Ký</button>
    </form>
  </div>
  <script>
    document.getElementById('elevatorCardForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      document.getElementById('successAlert').style.display = 'none';
      document.getElementById('errorAlert').style.display = 'none';
      const formData = new FormData(this);
      try {
        const response = await fetch('/api/elevator-card-register', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        if (response.ok && result.success) {
          // Hiển thị popup hiện đại giống car-registration
          showSuccessPopup({
            fullName: this.fullName.value,
            email: this.email.value,
            phone: this.phone.value,
            apartment: this.apartment.value,
            role: this.role.options[this.role.selectedIndex].text,
            cardQuantity: this.cardQuantity.value,
            note: this.note.value,
            chungcuName: result.chungcuName,
            createdAt: result.createdAt
          });
          this.reset();
        } else {
          document.getElementById('errorAlert').textContent = result.error || 'Có lỗi xảy ra.';
          document.getElementById('errorAlert').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('errorAlert').textContent = 'Không thể gửi đăng ký. Vui lòng thử lại sau.';
        document.getElementById('errorAlert').style.display = 'block';
      }
    });

    // Popup xác nhận thành công (đồng bộ UI/UX car-registration)
    function showSuccessPopup(info) {
      // Định dạng ngày đăng ký
      let dateStr = '';
      if (info.createdAt) {
        try {
          const d = new Date(info.createdAt);
          dateStr = d.toLocaleString('vi-VN', { hour12: false });
        } catch (e) { dateStr = info.createdAt; }
      }
      const popup = document.createElement('div');
      popup.id = 'successPopup';
      popup.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popup.innerHTML = `
        <div id="popupContent" style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;max-width:420px;width:95%;box-shadow:0 8px 32px rgba(124,92,246,0.10);text-align:center;">
          <div style="font-size:2.2em;color:#28a745;margin-bottom:12px;">✔️</div>
          <div style="font-size:1.3em;font-weight:700;color:#7C3AED;margin-bottom:10px;">Đăng ký thẻ thang máy thành công!</div>
          <div style="font-size:1.1em;font-weight:600;color:#333;margin-bottom:8px;">${info.chungcuName ? 'Chung cư: ' + info.chungcuName : ''}</div>
          <div style="font-size:1em;color:#555;margin-bottom:8px;">${dateStr ? 'Ngày đăng ký: ' + dateStr : ''}</div>
          <div style="text-align:left;font-size:1em;margin-bottom:18px;">
            <b>Họ tên:</b> ${info.fullName}<br>
            <b>Email:</b> ${info.email}<br>
            <b>Số điện thoại:</b> ${info.phone}<br>
            <b>Căn hộ:</b> ${info.apartment}<br>
            <b>Vai trò:</b> ${info.role}<br>
            <b>Số lượng thẻ:</b> ${info.cardQuantity}<br>
            <b>Ghi chú:</b> ${info.note || ''}
          </div>
          <div style="display:flex;justify-content:center;gap:12px;margin-top:10px;">
            <button class="btn btn-primary" style="background:#7C3AED;border:none;padding:12px 22px;font-size:1em;border-radius:8px;font-weight:600;color:#fff;box-shadow:0 2px 8px #e9e4fa;transition:background 0.2s;cursor:pointer;" onclick="downloadRegistrationInfo()">Tải xuống thông tin</button>
            <button class="btn btn-secondary" style="background:#e9e4fa;color:#7C3AED;border:none;padding:12px 22px;font-size:1em;border-radius:8px;font-weight:600;box-shadow:0 2px 8px #f3eaff;transition:background 0.2s;cursor:pointer;" onclick="closeSuccessPopup()">Đóng</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
      window._lastRegistrationInfo = info;
    }
    function closeSuccessPopup() {
      const popup = document.getElementById('successPopup');
      if (popup) popup.remove();
      window.location.href = '/tenants';
    }
    function downloadRegistrationInfo() {
      const popupContent = document.getElementById('popupContent');
      if (!popupContent) return;
      if (typeof html2canvas === 'undefined') {
        alert('Không thể tải ảnh. Thiếu thư viện html2canvas.');
        return;
      }
      html2canvas(popupContent).then(function(canvas) {
        const link = document.createElement('a');
        link.download = 'thong-tin-dang-ky-the-thang-may.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
    // Popup xác nhận thành công (đồng bộ UI/UX car-registration)
    function showSuccessPopup(info) {
      // Định dạng ngày đăng ký
      let dateStr = '';
      if (info.createdAt) {
        try {
          const d = new Date(info.createdAt);
          dateStr = d.toLocaleString('vi-VN', { hour12: false });
        } catch (e) { dateStr = info.createdAt; }
      }
      const popup = document.createElement('div');
      popup.id = 'successPopup';
      popup.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:2000;display:flex;align-items:center;justify-content:center;';
      popup.innerHTML = `
        <div id="popupContent" style="background:#fff;padding:32px 28px 24px 28px;border-radius:12px;max-width:420px;width:95%;box-shadow:0 8px 32px rgba(124,92,246,0.10);text-align:center;">
          <div style="font-size:2.2em;color:#28a745;margin-bottom:12px;">✔️</div>
          <div style="font-size:1.3em;font-weight:700;color:#7C3AED;margin-bottom:10px;">Đăng ký thẻ thang máy thành công!</div>
          <div style="font-size:1.1em;font-weight:600;color:#333;margin-bottom:8px;">${info.chungcuName ? 'Chung cư: ' + info.chungcuName : ''}</div>
          <div style="font-size:1em;color:#555;margin-bottom:8px;">${dateStr ? 'Ngày đăng ký: ' + dateStr : ''}</div>
          <div style="text-align:left;font-size:1em;margin-bottom:18px;">
            <b>Họ tên:</b> ${info.fullName}<br>
            <b>Email:</b> ${info.email}<br>
            <b>Số điện thoại:</b> ${info.phone}<br>
            <b>Căn hộ:</b> ${info.apartment}<br>
            <b>Vai trò:</b> ${info.role}<br>
            <b>Số lượng thẻ:</b> ${info.cardQuantity}<br>
            <b>Ghi chú:</b> ${info.note || ''}
          </div>
          <div style="display:flex;justify-content:center;gap:12px;margin-top:10px;">
            <button class="btn btn-primary" style="background:#7C3AED;border:none;padding:12px 22px;font-size:1em;border-radius:8px;font-weight:600;color:#fff;box-shadow:0 2px 8px #e9e4fa;transition:background 0.2s;cursor:pointer;" onclick="downloadRegistrationInfo()">Tải xuống thông tin</button>
            <button class="btn btn-secondary" style="background:#e9e4fa;color:#7C3AED;border:none;padding:12px 22px;font-size:1em;border-radius:8px;font-weight:600;box-shadow:0 2px 8px #f3eaff;transition:background 0.2s;cursor:pointer;" onclick="closeSuccessPopup()">Đóng</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);
      window._lastRegistrationInfo = info;
    }
    function closeSuccessPopup() {
      const popup = document.getElementById('successPopup');
      if (popup) popup.remove();
      window.location.href = '/tenants';
    }
    function downloadRegistrationInfo() {
      const popupContent = document.getElementById('popupContent');
      if (!popupContent) return;
      if (typeof html2canvas === 'undefined') {
        alert('Không thể tải ảnh. Thiếu thư viện html2canvas.');
        return;
      }
      html2canvas(popupContent).then(function(canvas) {
        const link = document.createElement('a');
        link.download = 'thong-tin-dang-ky-the-thang-may.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
    // Custom upload box trigger
    const uploadBox = document.getElementById('uploadBox');
    const cccdInput = document.getElementById('cccdFiles');
    const fileList = document.getElementById('fileList');

    uploadBox.addEventListener('click', function() {
      cccdInput.click();
    });

    // Drag & drop effect
    uploadBox.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });
    uploadBox.addEventListener('dragleave', function(e) {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
    });
    uploadBox.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
      cccdInput.files = e.dataTransfer.files;
      showFileList();
    });

    // Show file list
    cccdInput.addEventListener('change', showFileList);
    function showFileList() {
      fileList.innerHTML = '';
      const files = cccdInput.files;
      if (files && files.length > 0) {
        for (let i = 0; i < files.length; i++) {
          const li = document.createElement('li');
          li.textContent = files[i].name;
          fileList.appendChild(li);
        }
      }
    }
    // Thêm script html2canvas nếu chưa có
    if (!window.html2canvasLoaded) {
      var script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
      script.onload = function() { window.html2canvasLoaded = true; };
      document.head.appendChild(script);
    }

    // Chữ ký xác nhận
    const signatureCanvas = document.getElementById('signatureCanvas');
    const signatureInput = document.getElementById('signature');
    const clearSignatureBtn = document.getElementById('clearSignatureBtn');
    let drawing = false;
    let ctx = signatureCanvas.getContext('2d');
    function resizeSignatureCanvas() {
      let w = 340, h = 140;
      if (window.innerWidth < 600) {
        w = Math.max(window.innerWidth - 40, 220);
        h = 180;
      }
      signatureCanvas.width = w;
      signatureCanvas.height = h;
      ctx.clearRect(0, 0, w, h);
    }
    resizeSignatureCanvas();
    window.addEventListener('resize', resizeSignatureCanvas);
    signatureCanvas.addEventListener('mousedown', function(e) {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    });
    signatureCanvas.addEventListener('mousemove', function(e) {
      if (!drawing) return;
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.strokeStyle = '#7C3AED';
      ctx.lineWidth = 2.5;
      ctx.lineCap = 'round';
      ctx.stroke();
    });
    signatureCanvas.addEventListener('mouseup', function(e) {
      drawing = false;
      saveSignature();
    });
    signatureCanvas.addEventListener('mouseleave', function(e) {
      drawing = false;
      saveSignature();
    });
    // Touch support
    signatureCanvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      drawing = true;
      const rect = signatureCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      ctx.beginPath();
      ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    });
    signatureCanvas.addEventListener('touchmove', function(e) {
      e.preventDefault();
      if (!drawing) return;
      const rect = signatureCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      ctx.strokeStyle = '#7C3AED';
      ctx.lineWidth = 2.5;
      ctx.lineCap = 'round';
      ctx.stroke();
    });
    signatureCanvas.addEventListener('touchend', function(e) {
      drawing = false;
      saveSignature();
    });
    function saveSignature() {
      signatureInput.value = signatureCanvas.toDataURL();
    }
    clearSignatureBtn.addEventListener('click', function(e) {
      e.preventDefault();
      ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
      signatureInput.value = '';
    });
    // Trước khi submit, kiểm tra đã ký chưa
    document.getElementById('elevatorCardForm').addEventListener('submit', function(e) {
      if (!signatureInput.value || signatureInput.value.length < 100) {
        e.preventDefault();
        document.getElementById('errorAlert').textContent = 'Vui lòng ký tên xác nhận trước khi gửi.';
        document.getElementById('errorAlert').style.display = 'block';
        return false;
      }
    }, true);
  </script>
</body>
</html>
